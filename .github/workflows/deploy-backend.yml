# ============================================================================
# Workflow: Construction et D√©ploiement du Backend Laravel
# Description: Installe les d√©pendances PHP et d√©ploie l'API Laravel
# D√©clencheur: Push sur la branche main
# ============================================================================
name: Build and Deploy Backend

on:
  push:
    branches: [ main ]        # D√©clench√© automatiquement lors du push sur main
  workflow_dispatch:          # Permet √©galement le d√©clenchement manuel

# ============================================================================
# JOBS: Deux √©tapes distinctes - Build puis Deploy
# ============================================================================
jobs:
  
  # ==========================================================================
  # √âTAPE 1: BUILD - Construction de l'application Laravel
  # Objectif: Installer les d√©pendances PHP et pr√©parer l'application
  # ==========================================================================
  build:
    name: üî® Construction du Backend
    runs-on: ubuntu-latest    # Utilise une machine virtuelle Ubuntu
    
    steps:
    # ------------------------------------------------------------------------
    # R√©cup√©ration du code source depuis le d√©p√¥t GitHub
    # ------------------------------------------------------------------------
    - name: üì• R√©cup√©ration du code source
      uses: actions/checkout@v3
    
    # ------------------------------------------------------------------------
    # Installation et configuration de PHP 8.2
    # Installe √©galement les extensions PHP n√©cessaires pour Laravel
    # ------------------------------------------------------------------------
    - name: ‚öôÔ∏è Configuration de PHP 8.2
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'                    # Version PHP requise par Laravel 11
        extensions: mbstring, xml, bcmath     # Extensions PHP n√©cessaires
        tools: composer:v2                    # Gestionnaire de d√©pendances PHP
    
    # ------------------------------------------------------------------------
    # Validation du fichier composer.json
    # V√©rifie que les d√©pendances sont correctement d√©finies
    # D√©tecte les erreurs de syntaxe ou de structure avant le build
    # ------------------------------------------------------------------------
    - name: ‚úÖ Validation de composer.json
      run: composer validate --strict
    
    # ------------------------------------------------------------------------
    # Installation des d√©pendances PHP via Composer
    # --no-dev: Exclut les d√©pendances de d√©veloppement (tests, debug)
    # --optimize-autoloader: Optimise le chargement automatique des classes
    # --no-interaction: Mode non-interactif (pas de questions)
    # --prefer-dist: T√©l√©charge les archives au lieu de cloner les repos Git
    # ------------------------------------------------------------------------
    - name: üì¶ Installation des d√©pendances Composer
      run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
    
    # ------------------------------------------------------------------------
    # Sauvegarde des fichiers pour l'√©tape de d√©ploiement
    # Permet de transf√©rer le code et les d√©pendances entre jobs
    # Conserv√© pendant 1 jour (suffisant pour le d√©ploiement)
    # ------------------------------------------------------------------------
    - name: üì¶ Sauvegarde de l'artefact de build
      uses: actions/upload-artifact@v4
      with:
        name: backend-build    # Nom de l'artefact
        path: .
        retention-days: 1


  # ==========================================================================
  # √âTAPE 2: DEPLOY - D√©ploiement sur le serveur Hostinger
  # Objectif: Transf√©rer les fichiers et configurer Laravel en production
  # ==========================================================================
  deploy:
    name: üöÄ D√©ploiement sur Hostinger
    runs-on: ubuntu-latest
    needs: build              # Attend la fin du job "build" avant de commencer
    
    
    steps:
    # ------------------------------------------------------------------------
    # R√©cup√©ration de l'artefact cr√©√© lors de l'√©tape de build
    # ------------------------------------------------------------------------
    - name: üì• T√©l√©chargement de l'artefact de build
      uses: actions/download-artifact@v4
      with:
        name: backend-build    # Nom de l'artefact √† t√©l√©charger
    
    # ------------------------------------------------------------------------
    # Transfert des fichiers vers Hostinger via SCP (Secure Copy Protocol)
    # Utilise les secrets GitHub pour l'authentification SSH s√©curis√©e
    # Exclut les fichiers sensibles (.env) et inutiles (.git, tests)
    # ------------------------------------------------------------------------
    - name: üì§ Transfert des fichiers vers Hostinger
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOSTINGER_SSH_HOST }}        # Adresse IP du serveur
        username: ${{ secrets.HOSTINGER_SSH_USER }}    # Nom d'utilisateur SSH
        key: ${{ secrets.HOSTINGER_SSH_KEY }}          # Cl√© priv√©e SSH
        port: ${{ secrets.HOSTINGER_SSH_PORT }}        # Port SSH (65002)
        source: ".,!.git,!.github,!node_modules,!tests,!.env"  # Fichiers √† copier
        target: "/home/${{ secrets.HOSTINGER_SSH_USER }}/backend/"  # Destination
    
    # ------------------------------------------------------------------------
    # Configuration de Laravel en production via SSH
    # Ex√©cute des commandes directement sur le serveur Hostinger
    # ------------------------------------------------------------------------
    - name: ‚öôÔ∏è Configuration de Laravel en production
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOSTINGER_SSH_HOST }}
        username: ${{ secrets.HOSTINGER_SSH_USER }}
        key: ${{ secrets.HOSTINGER_SSH_KEY }}
        port: ${{ secrets.HOSTINGER_SSH_PORT }}
        script: |
          # Navigation vers le dossier backend
          cd /home/${{ secrets.HOSTINGER_SSH_USER }}/backend/
          
          # ----------------------------------------------------------------
          # Configuration des permissions d'√©criture
          # chmod 755: Lecture/√âcriture/Ex√©cution pour propri√©taire
          #            Lecture/Ex√©cution pour groupe et autres
          # N√©cessaire pour que Laravel puisse √©crire les logs et le cache
          # ----------------------------------------------------------------
          chmod -R 755 storage bootstrap/cache
          
          # ----------------------------------------------------------------
          # Mise en cache de la configuration Laravel
          # Combine tous les fichiers config/ en un seul fichier optimis√©
          # Am√©liore significativement les performances en production
          # ----------------------------------------------------------------
          php artisan config:cache
          
          # ----------------------------------------------------------------
          # Mise en cache des routes
          # Compile toutes les routes en un seul fichier
          # R√©duit le temps de r√©ponse des requ√™tes HTTP
          # ----------------------------------------------------------------
          php artisan route:cache
          
          # ----------------------------------------------------------------
          # Mise en cache des vues Blade
          # Pr√©-compile tous les templates Blade
          # Optimise le rendu des pages
          # ----------------------------------------------------------------
          php artisan view:cache
          
          # Message de confirmation
          echo "‚úÖ Configuration Laravel termin√©e avec succ√®s!"
    
    # ------------------------------------------------------------------------
    # Notification de succ√®s du d√©ploiement
    # ------------------------------------------------------------------------
    - name: ‚úÖ D√©ploiement termin√© avec succ√®s
      run: |
        echo "üéâ Backend d√©ploy√© avec succ√®s sur https://schoolproject.fr/api"
        echo "üìä Statistiques du d√©ploiement:"
        echo "  - Plateforme: Hostinger"
        echo "  - API URL: https://schoolproject.fr/api"
        echo "  - Date: $(date)"